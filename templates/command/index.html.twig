{% extends 'base.html.twig' %}

{% block title %}Command index{% endblock %}

{% block body %}
    <button class="refresh float-right btn btn-warning">Refresh</button>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h2>Commandes en attente</h2>
                {% for command in commands %}
                    {% if command.state.value == 1 %}
                        <div class="command">
                        <div class="header">
                            <div class=" float-right m-2">
                                <button data-id="{{ command.id }}" data-state-id="2" class="btn btn-success accept">Accepter</button>
                                <button data-id="{{ command.id }}" data-state-id="3" class="btn btn-danger deny">Refuser</button>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Pour {{ command.time.hourCommand }}</span>
                                <span> Par
                                    {{ command.user.Fname }}
                                    {{ command.user.Lname }}
                                </span>
                                <span>Tel: {{ command.user.phone }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    Crée le {{ command.datetime | date("j M") }} à  {{ command.datetime | date("H:i") }}
                                </div>
                                <div>
                                   Prix: {{ command.totalPrice }} €
                                </div>
                            </div>
                        </div>
                        <div class="row">


                        {% if command.commandAssocs%}
                            <div class="col-6">
                                <div>
                                    <div class="ml-3">A la carte:</div>
                                    {% for assoc in command.commandAssocs %}
                                        <div class="ml-5">{{ assoc.quantity }} {{ assoc.assoc.type.name }}s {{ assoc.assoc.product.name }}</div>
                                    {% else %}
                                        <div class="ml-5">Aucun produit à la carte</div>
                                    {%  endfor %}
                                </div>
                            </div>
                        {% endif %}

                        {% if command.commandMenus %}

                            <div class="col-6">
                                <div>
                                    <div class="ml-3">Menus:</div>
                                    {% for menu in command.commandMenus %}
                                        <div class="ml-5">{{ menu.quantity }}{{ menu.menu.name }}</div>
                                    {% else %}
                                        <div class="ml-5">Aucun menu</div>
                                    {%  endfor %}
                                </div>
                            </div>
                            </div>
                            </div>
                        {% endif %}
                    {%  endif %}
                {% else %}
                    <h3>Pas de commande en attente de validation</h3>
                {% endfor %}
            </div>

            <div class="col-sm-6">
                <h2>Commandes en cours</h2>
                {% for command in commands %}
                    {% if command.state.value == 2 %}
                        <div class="command">
                        <div class="header">
                            <div class=" float-right m-2">
                                <button data-id="{{ command.id }}" data-state-id="4" class="btn btn-info finish">Terminé</button></div>
                            <div class="d-flex justify-content-between">
                                <span>Pour {{ command.time.hourCommand }}</span>
                                <span> Par
                                    {{ command.user.Fname }}
                                    {{ command.user.Lname }}
                                </span>
                                <span>Tel: {{ command.user.phone }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    Crée le {{ command.datetime | date("j M") }} à  {{ command.datetime | date("H:i") }}
                                </div>
                                <div>
                                    Prix: {{ command.totalPrice }} €
                                </div>
                            </div>
                        </div>
                        <div class="row">


                        {% if command.commandAssocs%}
                            <div class="col-6">
                                <div>
                                    <div class="ml-3">A la carte:</div>
                                    {% for assoc in command.commandAssocs %}
                                        <div class="ml-5">{{ assoc.quantity }} {{ assoc.assoc.type.name }}s {{ assoc.assoc.product.name }}</div>
                                    {% else %}
                                        <div class="ml-5">Aucun produit à la carte</div>
                                    {%  endfor %}
                                </div>
                            </div>
                        {% endif %}

                        {% if command.commandMenus %}

                            <div class="col-6">
                                <div>
                                    <div class="ml-3">Menus:</div>
                                    {% for menu in command.commandMenus %}
                                        <div class="ml-5">{{ menu.quantity }}{{ menu.menu.name }}</div>
                                    {% else %}
                                        <div class="ml-5">Aucun menu</div>
                                    {%  endfor %}
                                </div>
                            </div>
                            </div>
                            </div>
                        {% endif %}
                    {%  endif %}
                {% else %}
                    <h3>Pas de commande en attente de validation</h3>
                {% endfor %}
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    <script>
        $(document).ready(function() {
            setTimeout(function(){
                location.reload();
            }, 60000);

            $('.refresh').on('click', function(){
                location.reload();
            });

            $('.accept, .deny, .finish').on('click', function() {
                let stateId = $(this).attr("data-state-id");
                let commandId = $(this).attr("data-id");
                $.ajax({
                    url: "/command/" + commandId,
                    type: "PATCH",
                    data: {
                        state: stateId
                    }
                }).then(function(response) {
                    console.log(response);

                }).catch(function(){
                    console.error('contacter l\'administrateur système.','une erreur est survenue');
                });
            });
        })
    </script>
{% endblock %}
